<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VexMail - Email Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #FFBB39;
            --white: #ffffff;
            --dark: #1d2731;
            --blue: #083c5d;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .email-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 187, 57, 0.1);
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .email-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: rgba(255, 187, 57, 0.3);
        }
        
        .email-item.unread {
            border-left: 4px solid var(--primary);
            background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
            box-shadow: 0 4px 15px rgba(255, 187, 57, 0.15);
        }
        
        .email-item.unread .email-sender {
            font-weight: 700;
            color: var(--dark);
        }
        
        .email-item.unread .email-subject {
            font-weight: 700;
            color: var(--dark);
        }
        
        .sidebar {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .compose-btn {
            background: linear-gradient(135deg, var(--primary) 0%, #ffd54f 100%);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(255, 187, 57, 0.3);
            transition: all 0.3s ease;
        }
        
        .compose-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 187, 57, 0.4);
        }
        
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .search-input {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .search-input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 187, 57, 0.1);
        }
        
        .email-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .pagination {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .pagination-btn {
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #10B981;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.error {
            background: #EF4444;
        }
        
        .toast.warning {
            background: #F59E0B;
        }
    </style>
</head>
<body class="text-gray-800">
    <!-- Header -->
    <header class="header">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <button id="sidebar-toggle" class="lg:hidden text-gray-600 hover:text-gray-900">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center shadow-lg">
                            <i class="fas fa-envelope text-white text-lg"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-900">VexMail</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search emails..." 
                               class="search-input pl-10 pr-4 py-2 w-64 focus:outline-none">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <button class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors">
                        <i class="fas fa-user text-gray-600"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out fixed lg:relative z-30 h-full">
            <div class="p-6">
                <div class="mb-6">
                    <button class="compose-btn w-full text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center space-x-2">
                        <i class="fas fa-plus"></i>
                        <span>Compose</span>
                    </button>
                </div>
                
                <nav class="space-y-2">
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-yellow-400 hover:text-gray-900 font-medium transition-all">
                        <i class="fas fa-inbox w-5"></i>
                        <span>Inbox</span>
                        <span class="ml-auto bg-yellow-400 text-gray-900 px-2 py-1 rounded-full text-xs font-bold" id="inbox-count">0</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-yellow-400 hover:text-gray-900 transition-all">
                        <i class="fas fa-star w-5"></i>
                        <span>Starred</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-yellow-400 hover:text-gray-900 transition-all">
                        <i class="fas fa-paper-plane w-5"></i>
                        <span>Sent</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-yellow-400 hover:text-gray-900 transition-all">
                        <i class="fas fa-file w-5"></i>
                        <span>Drafts</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-yellow-400 hover:text-gray-900 transition-all">
                        <i class="fas fa-trash w-5"></i>
                        <span>Trash</span>
                    </a>
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col">
            <!-- Email List Header -->
            <div class="header px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <input type="checkbox" id="select-all" class="rounded border-gray-300 text-yellow-500 focus:ring-yellow-500">
                        <button id="refresh-btn" class="text-gray-600 hover:text-gray-900 p-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-redo"></i>
                        </button>
                        <div class="hidden sm:flex items-center space-x-2" id="batch-actions">
                            <button id="mark-read-btn" class="text-sm text-gray-600 hover:text-gray-900 px-3 py-1 rounded-lg hover:bg-gray-100">
                                <i class="fas fa-check mr-1"></i>Mark Read
                            </button>
                            <button id="mark-unread-btn" class="text-sm text-gray-600 hover:text-gray-900 px-3 py-1 rounded-lg hover:bg-gray-100">
                                <i class="fas fa-envelope mr-1"></i>Mark Unread
                            </button>
                            <button id="delete-selected-btn" class="text-sm text-red-600 hover:text-red-700 px-3 py-1 rounded-lg hover:bg-red-50">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <span id="email-count">0 emails</span>
                        <span class="hidden sm:inline">•</span>
                        <span id="last-updated">Just now</span>
                    </div>
                </div>
            </div>

            <!-- Email List -->
            <div class="flex-1 overflow-hidden">
                <div class="h-full flex">
                    <!-- Email List Panel -->
                    <div class="w-full lg:w-1/2 overflow-y-auto p-4">
                        <div id="email-list" class="space-y-2">
                            <!-- Loading state -->
                            <div id="loading" class="flex items-center justify-center py-12">
                                <div class="loading-spinner"></div>
                                <span class="ml-3 text-gray-600">Loading emails...</span>
                            </div>
                            
                            <!-- Empty state -->
                            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-12">
                                <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No emails found</h3>
                                <p class="text-gray-500">Your inbox is empty or there was an error loading emails.</p>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="pagination" class="pagination mt-6 p-4 hidden">
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-600">
                                    <span id="pagination-info">Showing 1-20 of 0 emails</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="prev-page" class="pagination-btn px-3 py-1 text-gray-600 hover:text-gray-900 disabled:opacity-50">
                                        <i class="fas fa-chevron-left mr-1"></i>Previous
                                    </button>
                                    <div class="flex space-x-1" id="page-buttons">
                                        <button class="pagination-btn px-3 py-1 text-gray-600 hover:text-gray-900 bg-yellow-400 text-white rounded">1</button>
                                    </div>
                                    <button id="next-page" class="pagination-btn px-3 py-1 text-gray-600 hover:text-gray-900 disabled:opacity-50">
                                        Next<i class="fas fa-chevron-right ml-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email Detail Panel -->
                    <div class="hidden lg:block lg:w-1/2 p-4">
                        <div id="email-detail" class="h-full flex flex-col">
                            <!-- Default state -->
                            <div id="default-detail" class="email-content flex-1 flex items-center justify-center">
                                <div class="text-center">
                                    <i class="fas fa-envelope-open text-6xl text-gray-300 mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">Select an email</h3>
                                    <p class="text-gray-500">Choose an email from the list to view its contents.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // Global variables
        let emails = [];
        let currentEmail = null;
        let selectedEmails = new Set();
        let currentPage = 1;
        let totalPages = 1;
        let totalEmails = 0;
        let perPage = 20;

        // DOM elements
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const emailList = document.getElementById('email-list');
        const emailDetail = document.getElementById('email-detail');
        const defaultDetail = document.getElementById('default-detail');
        const loading = document.getElementById('loading');
        const emptyState = document.getElementById('empty-state');
        const inboxCount = document.getElementById('inbox-count');
        const emailCount = document.getElementById('email-count');
        const lastUpdated = document.getElementById('last-updated');
        const selectAll = document.getElementById('select-all');
        const refreshBtn = document.getElementById('refresh-btn');
        const searchInput = document.getElementById('search-input');
        const pagination = document.getElementById('pagination');
        const paginationInfo = document.getElementById('pagination-info');
        const prevPage = document.getElementById('prev-page');
        const nextPage = document.getElementById('next-page');
        const pageButtons = document.getElementById('page-buttons');

        // Toggle sidebar on mobile
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth < 1024 && 
                !sidebar.contains(e.target) && 
                !sidebarToggle.contains(e.target)) {
                sidebar.classList.add('-translate-x-full');
            }
        });

        // Toast notification system
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Fetch emails from API with pagination
        async function fetchEmails(page = 1) {
            try {
                currentPage = page;
                const response = await fetch(`/api/emails?page=${page}&per_page=${perPage}`);
                const data = await response.json();
                
                emails = data.emails;
                totalEmails = data.pagination.total;
                totalPages = data.pagination.pages;
                
                loading.classList.add('hidden');
                
                if (emails.length === 0) {
                    emptyState.classList.remove('hidden');
                    pagination.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    renderEmailList();
                    updateCounts();
                    updatePagination();
                }
            } catch (error) {
                console.error('Error fetching emails:', error);
                loading.classList.add('hidden');
                emptyState.classList.remove('hidden');
                showToast('Failed to load emails', 'error');
            }
        }

        // Update pagination
        function updatePagination() {
            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }
            
            pagination.classList.remove('hidden');
            
            const start = (currentPage - 1) * perPage + 1;
            const end = Math.min(currentPage * perPage, totalEmails);
            paginationInfo.textContent = `Showing ${start}-${end} of ${totalEmails} emails`;
            
            // Update page buttons
            pageButtons.innerHTML = '';
            
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.className = `pagination-btn px-3 py-1 text-gray-600 hover:text-gray-900 ${i === currentPage ? 'bg-yellow-400 text-white' : ''} rounded`;
                button.textContent = i;
                button.addEventListener('click', () => fetchEmails(i));
                pageButtons.appendChild(button);
            }
            
            // Update prev/next buttons
            prevPage.disabled = currentPage === 1;
            nextPage.disabled = currentPage === totalPages;
        }

        // Pagination event listeners
        prevPage.addEventListener('click', () => {
            if (currentPage > 1) {
                fetchEmails(currentPage - 1);
            }
        });

        nextPage.addEventListener('click', () => {
            if (currentPage < totalPages) {
                fetchEmails(currentPage + 1);
            }
        });

        // Mark email as read/unread
        async function markEmailAsRead(uid, isRead = true) {
            try {
                const endpoint = isRead ? `/api/emails/${uid}/read` : `/api/emails/${uid}/unread`;
                const response = await fetch(endpoint, { method: 'POST' });
                
                if (response.ok) {
                    const email = emails.find(e => e.id === uid);
                    if (email) {
                        email.is_read = isRead;
                        renderEmailList();
                        updateCounts();
                        showToast(`Email marked as ${isRead ? 'read' : 'unread'}`);
                    }
                } else {
                    throw new Error('Failed to update email status');
                }
            } catch (error) {
                console.error('Error marking email:', error);
                showToast('Failed to update email status', 'error');
            }
        }

        // Delete email
        async function deleteEmail(uid) {
            if (!confirm('Are you sure you want to delete this email?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/emails/${uid}`, { method: 'DELETE' });
                
                if (response.ok) {
                    emails = emails.filter(e => e.id !== uid);
                    renderEmailList();
                    updateCounts();
                    showToast('Email deleted successfully');
                } else {
                    throw new Error('Failed to delete email');
                }
            } catch (error) {
                console.error('Error deleting email:', error);
                showToast('Failed to delete email', 'error');
            }
        }

        // Render email list
        function renderEmailList(emailsToRender = emails) {
            const emailListHTML = emailsToRender.map((email, index) => `
                <div class="email-item p-4 cursor-pointer ${!email.is_read ? 'unread' : ''}" 
                     data-email-id="${email.id}">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <input type="checkbox" class="email-checkbox rounded border-gray-300 text-yellow-500 focus:ring-yellow-500" 
                                   data-email-id="${email.id}" ${selectedEmails.has(email.id) ? 'checked' : ''}>
                        </div>
                        <div class="flex-1 min-w-0" onclick="showEmailDetail('${email.id}')">
                            <div class="flex items-center justify-between">
                                <p class="email-sender text-sm font-medium text-gray-900 truncate">${email.from}</p>
                                <p class="email-date text-xs text-gray-500">${email.date}</p>
                            </div>
                            <p class="email-subject text-sm font-semibold text-gray-900 truncate mt-1">${email.subject || '(No Subject)'}</p>
                            <p class="email-preview text-sm text-gray-600 truncate mt-1">${email.preview}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            emailList.innerHTML = emailListHTML;
            addEmailEventListeners();
        }

        // Add event listeners to email items
        function addEmailEventListeners() {
            document.querySelectorAll('.email-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const emailId = e.target.dataset.emailId;
                    if (e.target.checked) {
                        selectedEmails.add(emailId);
                    } else {
                        selectedEmails.delete(emailId);
                    }
                    updateBatchActions();
                });
            });
        }

        // Update batch actions visibility
        function updateBatchActions() {
            const batchActions = document.getElementById('batch-actions');
            if (selectedEmails.size > 0) {
                batchActions.classList.remove('hidden');
            } else {
                batchActions.classList.add('hidden');
            }
        }

        // Select all emails
        selectAll.addEventListener('change', (e) => {
            if (e.target.checked) {
                emails.forEach(email => selectedEmails.add(email.id));
            } else {
                selectedEmails.clear();
            }
            renderEmailList();
            updateBatchActions();
        });

        // Batch operations
        document.getElementById('mark-read-btn').addEventListener('click', () => {
            selectedEmails.forEach(uid => markEmailAsRead(uid, true));
            selectedEmails.clear();
            renderEmailList();
            updateBatchActions();
        });

        document.getElementById('mark-unread-btn').addEventListener('click', () => {
            selectedEmails.forEach(uid => markEmailAsRead(uid, false));
            selectedEmails.clear();
            renderEmailList();
            updateBatchActions();
        });

        document.getElementById('delete-selected-btn').addEventListener('click', () => {
            if (confirm(`Are you sure you want to delete ${selectedEmails.size} email(s)?`)) {
                selectedEmails.forEach(uid => deleteEmail(uid));
                selectedEmails.clear();
                renderEmailList();
                updateBatchActions();
            }
        });

        // Refresh emails
        refreshBtn.addEventListener('click', () => {
            fetchEmails(currentPage);
            showToast('Refreshing emails...', 'warning');
        });

        // Search functionality
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredEmails = emails.filter(email => 
                email.subject.toLowerCase().includes(searchTerm) ||
                email.from.toLowerCase().includes(searchTerm) ||
                email.body.toLowerCase().includes(searchTerm)
            );
            renderEmailList(filteredEmails);
        });

        // Show email detail
        function showEmailDetail(emailId) {
            const email = emails.find(e => e.id === emailId);
            if (!email) return;
            
            currentEmail = email;
            
            // Mark as read when opened
            if (!email.is_read) {
                markEmailAsRead(emailId, true);
            }
            
            const detailHTML = `
                <div class="email-content h-full flex flex-col">
                    <div class="border-b border-gray-200 p-6">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center shadow-lg">
                                    <span class="text-white font-semibold text-lg">${email.from.charAt(0).toUpperCase()}</span>
                                </div>
                                <div>
                                    <h2 class="text-lg sm:text-xl font-bold text-gray-900">${email.subject || '(No Subject)'}</h2>
                                    <p class="text-gray-600 text-sm">From: ${email.from} &lt;${email.email}&gt;</p>
                                    <p class="text-sm text-gray-500">${email.date}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="p-2 text-gray-600 hover:text-gray-900 rounded-lg hover:bg-gray-100">
                                    <i class="fas fa-reply"></i>
                                </button>
                                <button class="p-2 text-gray-600 hover:text-gray-900 rounded-lg hover:bg-gray-100">
                                    <i class="fas fa-forward"></i>
                                </button>
                                <button class="p-2 text-red-600 hover:text-red-700 rounded-lg hover:bg-red-50" onclick="deleteEmail('${email.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 p-6 overflow-y-auto">
                        <div class="prose max-w-none">
                            <div class="whitespace-pre-wrap text-gray-800 leading-relaxed text-sm sm:text-base">${email.body}</div>
                        </div>
                    </div>
                </div>
            `;
            
            emailDetail.innerHTML = detailHTML;
            defaultDetail.classList.add('hidden');
        }

        // Update counts
        function updateCounts() {
            const unreadCount = emails.filter(e => !e.is_read).length;
            inboxCount.textContent = totalEmails;
            emailCount.textContent = `${totalEmails} emails (${unreadCount} unread)`;
            lastUpdated.textContent = 'Just now';
        }

        // Initial load
        fetchEmails(1);
    </script>
</body>
</html>
